---
title: Testing Reference
description: Testing utilities API reference
author: zoobzio
published: 2025-12-11
updated: 2025-12-11
tags:
  - Reference
  - Testing
---

# Testing Reference

The `aperture/testing` package provides utilities for testing aperture configurations.

## Import

```go
import apertesting "github.com/zoobzio/aperture/testing"
```

## Providers

### TestProviders

```go
func TestProviders(
    ctx context.Context,
    serviceName string,
    serviceVersion string,
    otlpEndpoint string,
) (*Providers, error)
```

Creates OTLP providers configured for testing with insecure connections.

**Parameters:**
- `ctx` - Context for provider creation
- `serviceName` - Service name for resource attribute
- `serviceVersion` - Service version for resource attribute
- `otlpEndpoint` - OTLP collector endpoint (e.g., "localhost:4318")

**Returns:**
- `*Providers` - Log, Meter, and Trace providers
- `error` - Validation or connection errors

**Example:**

```go
pvs, err := apertesting.TestProviders(ctx, "test-service", "v1.0.0", "localhost:4318")
if err != nil {
    t.Skip("collector not available")
}
defer pvs.Shutdown(ctx)

ap, _ := aperture.New(cap, pvs.Log, pvs.Meter, pvs.Trace)
```

### Providers

```go
type Providers struct {
    Log   *sdklog.LoggerProvider
    Meter *sdkmetric.MeterProvider
    Trace *sdktrace.TracerProvider
}
```

### Providers.Shutdown

```go
func (p *Providers) Shutdown(ctx context.Context) error
```

Shuts down all providers gracefully.

## Mock Logger

### NewMockLoggerProvider

```go
func NewMockLoggerProvider() *MockLoggerProvider
```

Creates a mock logger provider that captures log records.

**Example:**

```go
mockLog := apertesting.NewMockLoggerProvider()
ap, _ := aperture.New(cap, mockLog, noop.NewMeterProvider(), tracenoop.NewTracerProvider())
```

### MockLoggerProvider

```go
type MockLoggerProvider struct {
    // ...
}
```

#### Logger

```go
func (p *MockLoggerProvider) Logger(name string, opts ...log.LoggerOption) log.Logger
```

Returns the mock logger (same instance for all names).

#### Capture

```go
func (p *MockLoggerProvider) Capture() *LogCapture
```

Returns the log capture for assertions.

### NewMockLogger

```go
func NewMockLogger() *MockLogger
```

Creates a standalone mock logger.

### MockLogger

```go
type MockLogger struct {
    // ...
}
```

#### Emit

```go
func (m *MockLogger) Emit(ctx context.Context, record log.Record)
```

Captures the log record.

#### Enabled

```go
func (m *MockLogger) Enabled(ctx context.Context, params log.EnabledParameters) bool
```

Always returns `true`.

#### Capture

```go
func (m *MockLogger) Capture() *LogCapture
```

Returns the log capture.

## Log Capture

### NewLogCapture

```go
func NewLogCapture() *LogCapture
```

Creates a new log capture instance.

### LogCapture

```go
type LogCapture struct {
    // ...
}
```

Thread-safe log record storage.

#### Records

```go
func (lc *LogCapture) Records() []log.Record
```

Returns a copy of all captured records.

#### Count

```go
func (lc *LogCapture) Count() int
```

Returns the number of captured records.

#### Reset

```go
func (lc *LogCapture) Reset()
```

Clears all captured records.

#### WaitForCount

```go
func (lc *LogCapture) WaitForCount(n int, timeout time.Duration) bool
```

Blocks until at least `n` records are captured or timeout expires.

**Returns:** `true` if count reached, `false` if timeout.

**Example:**

```go
if !capture.WaitForCount(5, time.Second) {
    t.Error("timeout waiting for logs")
}
```

## Event Capture

### NewEventCapture

```go
func NewEventCapture() *EventCapture
```

Creates a new event capture instance.

### EventCapture

```go
type EventCapture struct {
    // ...
}
```

Thread-safe capitan event storage.

#### Handler

```go
func (ec *EventCapture) Handler() capitan.EventCallback
```

Returns a callback for `capitan.Hook()`.

**Example:**

```go
capture := apertesting.NewEventCapture()
cap.Hook(sig, capture.Handler())
```

#### Events

```go
func (ec *EventCapture) Events() []CapturedEvent
```

Returns a copy of all captured events.

#### Count

```go
func (ec *EventCapture) Count() int
```

Returns the number of captured events.

#### Reset

```go
func (ec *EventCapture) Reset()
```

Clears all captured events.

#### WaitForCount

```go
func (ec *EventCapture) WaitForCount(n int, timeout time.Duration) bool
```

Blocks until at least `n` events are captured or timeout expires.

### CapturedEvent

```go
type CapturedEvent struct {
    Signal    capitan.Signal
    Timestamp time.Time
    Severity  capitan.Severity
    Fields    []capitan.Field
}
```

Snapshot of a capitan event.

## Usage with Noop Providers

For tests that only verify logging:

```go
import (
    "go.opentelemetry.io/otel/metric/noop"
    tracenoop "go.opentelemetry.io/otel/trace/noop"
)

func TestLogging(t *testing.T) {
    mockLog := apertesting.NewMockLoggerProvider()

    ap, _ := aperture.New(
        cap,
        mockLog,
        noop.NewMeterProvider(),
        tracenoop.NewTracerProvider(),
    )
    // ...
}
```

## Common Test Patterns

### Verify Log Count

```go
func TestLogCount(t *testing.T) {
    mockLog := apertesting.NewMockLoggerProvider()
    ap, _ := aperture.New(cap, mockLog, noop.NewMeterProvider(), tracenoop.NewTracerProvider())
    defer ap.Close()

    cap.Emit(ctx, sig)
    cap.Emit(ctx, sig)
    cap.Shutdown()

    if mockLog.Capture().Count() != 2 {
        t.Errorf("expected 2 logs")
    }
}
```

### Verify Whitelist Filtering

```go
func TestWhitelist(t *testing.T) {
    allowed := capitan.NewSignal("allowed", "")
    blocked := capitan.NewSignal("blocked", "")

    schema := aperture.Schema{
        Logs: &aperture.LogSchema{
            Whitelist: []string{"allowed"},
        },
    }

    mockLog := apertesting.NewMockLoggerProvider()
    ap, _ := aperture.New(cap, mockLog, noop.NewMeterProvider(), tracenoop.NewTracerProvider())
    ap.Apply(schema)
    defer ap.Close()

    cap.Emit(ctx, allowed)
    cap.Emit(ctx, blocked)
    cap.Shutdown()

    if mockLog.Capture().Count() != 1 {
        t.Error("whitelist filtering failed")
    }
}
```

### Wait for Async Events

```go
func TestAsync(t *testing.T) {
    mockLog := apertesting.NewMockLoggerProvider()
    // ... setup ...

    go func() {
        for i := 0; i < 10; i++ {
            cap.Emit(ctx, sig)
        }
    }()

    if !mockLog.Capture().WaitForCount(10, 5*time.Second) {
        t.Error("timeout")
    }
}
```
