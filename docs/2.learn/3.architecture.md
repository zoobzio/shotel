---
title: Architecture
description: Internal design and implementation details
author: zoobzio
published: 2025-12-11
updated: 2025-12-11
tags:
  - Learn
  - Architecture
---

# Architecture

## Component Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                           Aperture                              │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                       Observer                            │  │
│  │  capitan.Observe() → receives all events                 │  │
│  └────────────────────────────┬─────────────────────────────┘  │
│                               │                                 │
│               ┌───────────────┼───────────────┐                 │
│               ▼               ▼               ▼                 │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐      │
│  │  Log Handler   │ │ Metric Handler │ │ Trace Handler  │      │
│  │                │ │                │ │                │      │
│  │  - Whitelist   │ │  - Counter     │ │  - Correlation │      │
│  │  - Transform   │ │  - Gauge       │ │  - Span start  │      │
│  │  - Context     │ │  - Histogram   │ │  - Span end    │      │
│  └────────┬───────┘ └───────┬────────┘ └───────┬────────┘      │
│           │                 │                   │                │
│           ▼                 ▼                   ▼                │
│  ┌────────────────┐ ┌────────────────┐ ┌────────────────┐      │
│  │  LogProvider   │ │ MeterProvider  │ │ TraceProvider  │      │
│  │  (from user)   │ │  (from user)   │ │  (from user)   │      │
│  └────────────────┘ └────────────────┘ └────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
```

## Event Flow

1. Application emits capitan event
2. Aperture's observer receives it
3. Three handlers process in parallel:
   - Log handler: filters, transforms, emits
   - Metric handler: increments/records metrics
   - Trace handler: starts/ends spans based on correlation

## Key Types

### Aperture

The main entry point. Registers as a capitan observer and holds references to providers.

```go
type Aperture struct {
    logProvider   log.LoggerProvider
    meterProvider metric.MeterProvider
    traceProvider trace.TracerProvider
    logger        log.Logger
    observer      capitan.Observer
    config        *Config
    // ...
}
```

### Config

Configuration for transformation rules:

```go
type Config struct {
    Metrics           []MetricConfig
    Traces            []TraceConfig
    Logs              *LogConfig
    ContextExtraction *ContextExtractionConfig
    Transformers      map[capitan.Variant]FieldTransformer
    StdoutLogging     bool
}
```

### MetricConfig

Defines how a signal becomes a metric:

```go
type MetricConfig struct {
    Signal      capitan.Signal
    Name        string
    Type        MetricType  // Counter, Gauge, Histogram, UpDownCounter
    ValueKey    capitan.Key // For non-counters
    Description string
}
```

### TraceConfig

Defines span correlation:

```go
type TraceConfig struct {
    Start          capitan.Signal
    End            capitan.Signal
    CorrelationKey *capitan.StringKey  // String field to match start/end
    SpanName       string
    SpanTimeout    time.Duration // Max wait for end event
}
```

## Field Transformation

The `transformer` component handles field-to-attribute conversion.

### Built-in Types

Direct mapping for primitive types:

| Capitan Type | OTEL Attribute |
|--------------|----------------|
| `string` | `log.String(key, value)` |
| `int`, `int32`, `int64` | `log.Int64(key, value)` |
| `float32`, `float64` | `log.Float64(key, value)` |
| `bool` | `log.Bool(key, value)` |
| `time.Time` | `log.Int64(key, unix)` |
| `time.Duration` | `log.Int64(key, nanos)` |
| `[]byte` | `log.Bytes(key, value)` |
| `error` | `log.String(key, err.Error())` |

### Custom Transformers

User-provided functions for custom types:

```go
type FieldTransformer func(f capitan.Field) []log.KeyValue
```

Created via `MakeTransformer` which handles the type extraction:

```go
transformer := aperture.MakeTransformer(func(key string, order OrderInfo) []log.KeyValue {
    return []log.KeyValue{
        log.String(key+".id", order.ID),
        log.Float64(key+".total", order.Total),
    }
})
```

## Trace Correlation

The trace handler maintains pending spans in a map keyed by correlation value:

```go
type pendingSpan struct {
    ctx       context.Context
    span      trace.Span
    startTime time.Time
}

pendingSpans map[string]*pendingSpan  // correlationValue -> span
```

### Flow

1. Start signal arrives with correlation key value
2. New span created, stored in pending map
3. Cleanup goroutine monitors for timeouts
4. End signal arrives with matching correlation value
5. Span retrieved from pending map and ended

### Out-of-Order Events

If end arrives before start:
- End event logged but span not created
- Subsequent start creates normal span
- No data loss, but span timing may be incorrect

## Context Extraction

Configured context keys are checked on each event:

```go
for _, ctxKey := range config.ContextExtraction.Logs {
    if value := ctx.Value(ctxKey.Key); value != nil {
        attrs = append(attrs, transformContextValue(ctxKey.Name, value))
    }
}
```

Only non-nil values are added as attributes.

## Thread Safety

- Aperture is safe for concurrent use
- Observer callback runs on capitan's worker goroutine per signal
- Pending span map uses mutex protection
- Provider calls are delegated to OTEL (thread-safe by design)

## Memory Management

- No event buffering beyond capitan's internal buffers
- Pending spans cleaned up on timeout
- Metrics use OTEL's instrument pooling

## Error Handling

- Provider errors logged but not propagated (best-effort observability)
- Invalid configurations rejected at creation time
- Missing correlation keys logged as warnings
- Transformation errors result in attribute omission, not failure

### Diagnostic Signals

Aperture emits internal signals at DEBUG severity for operational visibility. Filter for `aperture.signal` attribute in your log aggregator:

| Signal | When Emitted | Resolution |
|--------|--------------|------------|
| `aperture:transform:skipped` | Custom field type has no registered transformer | Register transformer via `Config.Transformers` |
| `aperture:metric:value_missing` | Gauge/histogram/updowncounter event lacks `ValueKey` field | Ensure event includes the required value field |
| `aperture:trace:correlation_missing` | Trace event lacks `CorrelationKey` field | Ensure event includes the correlation field |
| `aperture:trace:expired` | Span start/end never matched within `SpanTimeout` | Check correlation IDs match, or increase timeout |

Example log output:

```
level=DEBUG msg="field transformation skipped due to unsupported type" aperture.signal=aperture:transform:skipped field_key=order field_variant=myapp.Order signal=order.created
```

## Schema System

For file-based configuration:

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│    Schema       │    │    Registry     │    │     Config      │
│  (YAML/JSON)    │───▶│ (name lookup)   │───▶│   (runtime)     │
│                 │    │                 │    │                 │
│  signal: "Foo"  │    │ Foo → Signal    │    │ Signal: sig     │
│  name: "metric" │    │ "bar" → Key     │    │ Name: "metric"  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

The Registry maps string names to actual capitan types, allowing schemas to reference signals and keys by name.
